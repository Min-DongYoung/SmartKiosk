<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ë¬¸ ë‚´ì—­ - ìŠ¤ë§ˆíŠ¸ í‚¤ì˜¤ìŠ¤í¬ ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <div class="header-container">
            <div class="logo">ğŸª ìŠ¤ë§ˆíŠ¸ í‚¤ì˜¤ìŠ¤í¬ ê´€ë¦¬ì</div>
            <nav class="nav-links">
                <a href="index.html">ëŒ€ì‹œë³´ë“œ</a>
                <a href="menus.html">ë©”ë‰´ ê´€ë¦¬</a>
                <a href="orders.html" class="active">ì£¼ë¬¸ ë‚´ì—­</a>
                <a href="statistics.html">ì£¼ë¬¸ í†µê³„</a>
                <a href="advertisements.html">ê´‘ê³  ê´€ë¦¬</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="card-header">
            <h1 class="card-title">ì£¼ë¬¸ ë‚´ì—­</h1>
            <button class="btn btn-secondary" onclick="refreshOrders()">
                ğŸ”„ ìƒˆë¡œê³ ì¹¨
            </button>
        </div>

        <!-- í•„í„° ë° ê²€ìƒ‰ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">í•„í„° ë° ê²€ìƒ‰</h2>
                <button class="btn btn-sm btn-secondary" onclick="resetFilters()">
                    ğŸ”„ í•„í„° ì´ˆê¸°í™”
                </button>
            </div>
            <div class="grid grid-4">
                <div class="form-group">
                    <label class="form-label">ì£¼ë¬¸ ìƒíƒœ</label>
                    <select class="form-select" id="statusFilter" onchange="applyFilters()">
                        <option value="">ì „ì²´ ìƒíƒœ</option>
                        <option value="pending">ëŒ€ê¸°ì¤‘</option>
                        <option value="preparing">ì¤€ë¹„ì¤‘</option>
                        <option value="ready">ì¤€ë¹„ì™„ë£Œ</option>
                        <option value="completed">ì™„ë£Œ</option>
                        <option value="cancelled">ì·¨ì†Œë¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ë‚ ì§œ ë²”ìœ„</label>
                    <select class="form-select" id="dateRangeFilter" onchange="applyFilters()">
                        <option value="">ì „ì²´ ê¸°ê°„</option>
                        <option value="today">ì˜¤ëŠ˜</option>
                        <option value="yesterday">ì–´ì œ</option>
                        <option value="week">ìµœê·¼ 7ì¼</option>
                        <option value="month">ìµœê·¼ 30ì¼</option>
                        <option value="custom">ì‚¬ìš©ì ì •ì˜</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ì‹œì‘ ë‚ ì§œ</label>
                    <input type="date" class="form-control" id="startDate" onchange="applyFilters()">
                </div>
                <div class="form-group">
                    <label class="form-label">ì¢…ë£Œ ë‚ ì§œ</label>
                    <input type="date" class="form-control" id="endDate" onchange="applyFilters()">
                </div>
            </div>
            <div class="grid grid-3">
                <div class="form-group">
                    <label class="form-label">ì£¼ë¬¸ë²ˆí˜¸ ê²€ìƒ‰</label>
                    <input type="text" class="form-control" id="orderIdSearch" placeholder="ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" onkeyup="applyFilters()">
                </div>
                <div class="form-group">
                    <label class="form-label">ë©”ë‰´ëª… ê²€ìƒ‰</label>
                    <input type="text" class="form-control" id="menuSearch" placeholder="ë©”ë‰´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" onkeyup="applyFilters()">
                </div>
                <div class="form-group">
                    <label class="form-label">ê¸ˆì•¡ ë²”ìœ„</label>
                    <select class="form-select" id="priceRangeFilter" onchange="applyFilters()">
                        <option value="">ì „ì²´ ê¸ˆì•¡</option>
                        <option value="0-10000">0 - 10,000ì›</option>
                        <option value="10000-20000">10,000 - 20,000ì›</option>
                        <option value="20000-50000">20,000 - 50,000ì›</option>
                        <option value="50000-999999">50,000ì› ì´ìƒ</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ì£¼ë¬¸ í†µê³„ -->
        <div class="grid grid-5">
            <div class="stat-card">
                <div class="stat-number" id="totalOrdersCount">-</div>
                <div class="stat-label">ì „ì²´ ì£¼ë¬¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingOrdersCount">-</div>
                <div class="stat-label">ëŒ€ê¸° ì¤‘</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedOrdersCount">-</div>
                <div class="stat-label">ì™„ë£Œ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalRevenue">-</div>
                <div class="stat-label">ì´ ë§¤ì¶œ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="averageOrderValue">-</div>
                <div class="stat-label">í‰ê·  ì£¼ë¬¸ì•¡</div>
            </div>
        </div>

        <!-- ì£¼ë¬¸ ëª©ë¡ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ì£¼ë¬¸ ëª©ë¡</h2>
                <div class="d-flex gap-2">
                    <select class="form-select" id="sortBy" onchange="applyFilters()" style="width: 200px;">
                        <option value="createdAt">ì£¼ë¬¸ì‹œê°„ìˆœ</option>
                        <option value="totalPrice">ê¸ˆì•¡ìˆœ</option>
                        <option value="status">ìƒíƒœìˆœ</option>
                        <option value="orderId">ì£¼ë¬¸ë²ˆí˜¸ìˆœ</option>
                    </select>
                    <button class="btn btn-sm btn-secondary" onclick="toggleSortOrder()">
                        <span id="sortOrderText">â¬‡ï¸</span>
                    </button>
                </div>
            </div>
            <div id="ordersList" class="table-responsive">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì£¼ë¬¸ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="orderDetailModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="modal-close" onclick="closeOrderDetailModal()">&times;</span>
            <h2>ì£¼ë¬¸ ìƒì„¸ ì •ë³´</h2>
            
            <div id="orderDetailContent">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="script.js"></script>
    <script>
        let allOrders = [];
        let filteredOrders = [];
        let sortOrder = 'desc';

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì£¼ë¬¸ ëª©ë¡ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', loadOrders);

        // ì£¼ë¬¸ ëª©ë¡ ë¡œë“œ
        async function loadOrders() {
            try {
                Loading.show('#ordersList');
                const response = await API.get('/orders?limit=100');
                allOrders = response.data;
                filteredOrders = [...allOrders];
                
                renderOrders();
                updateStatistics();
                
            } catch (error) {
                console.error('ì£¼ë¬¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                Notification.error('ì£¼ë¬¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                Loading.hide('#ordersList');
            }
        }

        // ì£¼ë¬¸ ë Œë”ë§
        function renderOrders() {
            const container = document.getElementById('ordersList');
            
            if (filteredOrders.length === 0) {
                container.innerHTML = '<p class="text-center">ì¡°ê±´ì— ë§ëŠ” ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const columns = [
                { 
                    key: 'orderId', 
                    header: 'ì£¼ë¬¸ë²ˆí˜¸',
                    render: (value) => `<strong>#${value}</strong>`
                },
                { 
                    key: 'items', 
                    header: 'ì£¼ë¬¸ ë‚´ì—­',
                    render: (items) => {
                        const firstItem = items[0];
                        const count = items.length;
                        const totalQuantity = items.reduce((sum, item) => sum + item.quantity, 0);
                        return count > 1 ? 
                            `${firstItem.name} ì™¸ ${count-1}ê°œ (ì´ ${totalQuantity}ê°œ)` : 
                            `${firstItem.name} (${firstItem.quantity}ê°œ)`;
                    }
                },
                { 
                    key: 'totalPrice', 
                    header: 'ì´ ê¸ˆì•¡',
                    render: (value) => `<strong>${Utils.formatPrice(value)}</strong>`
                },
                { 
                    key: 'status', 
                    header: 'ìƒíƒœ',
                    render: (value) => `<span class="badge ${Utils.getOrderStatusBadge(value)}">${Utils.getOrderStatusName(value)}</span>`
                },
                { 
                    key: 'createdAt', 
                    header: 'ì£¼ë¬¸ì‹œê°„',
                    render: (value) => Utils.formatDate(value)
                },
                { 
                    key: 'updatedAt', 
                    header: 'ìµœê·¼ ì—…ë°ì´íŠ¸',
                    render: (value) => Utils.formatDate(value)
                }
            ];

            const actions = [
                {
                    text: 'ìƒì„¸ë³´ê¸°',
                    class: 'btn-primary',
                    onClick: (order) => showOrderDetail(order)
                },
                {
                    text: 'ìƒíƒœë³€ê²½',
                    class: 'btn-warning',
                    onClick: (order) => showStatusChangeModal(order)
                }
            ];

            Table.render(container, filteredOrders, columns, actions);
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics() {
            const total = filteredOrders.length;
            const pending = filteredOrders.filter(order => order.status === 'pending').length;
            const completed = filteredOrders.filter(order => order.status === 'completed').length;
            const totalRevenue = filteredOrders.reduce((sum, order) => sum + order.totalPrice, 0);
            const averageOrderValue = total > 0 ? Math.round(totalRevenue / total) : 0;

            document.getElementById('totalOrdersCount').textContent = total;
            document.getElementById('pendingOrdersCount').textContent = pending;
            document.getElementById('completedOrdersCount').textContent = completed;
            document.getElementById('totalRevenue').textContent = Utils.formatPrice(totalRevenue);
            document.getElementById('averageOrderValue').textContent = Utils.formatPrice(averageOrderValue);
        }

        // í•„í„° ì ìš©
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const dateRangeFilter = document.getElementById('dateRangeFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const orderIdSearch = document.getElementById('orderIdSearch').value.toLowerCase();
            const menuSearch = document.getElementById('menuSearch').value.toLowerCase();
            const priceRangeFilter = document.getElementById('priceRangeFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            // ë‚ ì§œ ë²”ìœ„ ì„¤ì •
            let dateFrom = null;
            let dateTo = null;
            
            if (dateRangeFilter === 'today') {
                dateFrom = new Date();
                dateFrom.setHours(0, 0, 0, 0);
                dateTo = new Date();
                dateTo.setHours(23, 59, 59, 999);
            } else if (dateRangeFilter === 'yesterday') {
                dateFrom = new Date();
                dateFrom.setDate(dateFrom.getDate() - 1);
                dateFrom.setHours(0, 0, 0, 0);
                dateTo = new Date();
                dateTo.setDate(dateTo.getDate() - 1);
                dateTo.setHours(23, 59, 59, 999);
            } else if (dateRangeFilter === 'week') {
                dateFrom = new Date();
                dateFrom.setDate(dateFrom.getDate() - 7);
                dateFrom.setHours(0, 0, 0, 0);
                dateTo = new Date();
            } else if (dateRangeFilter === 'month') {
                dateFrom = new Date();
                dateFrom.setDate(dateFrom.getDate() - 30);
                dateFrom.setHours(0, 0, 0, 0);
                dateTo = new Date();
            } else if (dateRangeFilter === 'custom') {
                if (startDate) {
                    dateFrom = new Date(startDate);
                    dateFrom.setHours(0, 0, 0, 0);
                }
                if (endDate) {
                    dateTo = new Date(endDate);
                    dateTo.setHours(23, 59, 59, 999);
                }
            }

            filteredOrders = allOrders.filter(order => {
                // ìƒíƒœ í•„í„°
                if (statusFilter && order.status !== statusFilter) return false;
                
                // ë‚ ì§œ í•„í„°
                const orderDate = new Date(order.createdAt);
                if (dateFrom && orderDate < dateFrom) return false;
                if (dateTo && orderDate > dateTo) return false;
                
                // ì£¼ë¬¸ë²ˆí˜¸ ê²€ìƒ‰
                if (orderIdSearch && !order.orderId.toLowerCase().includes(orderIdSearch)) return false;
                
                // ë©”ë‰´ëª… ê²€ìƒ‰
                if (menuSearch) {
                    const hasMatchingItem = order.items.some(item => 
                        item.name.toLowerCase().includes(menuSearch)
                    );
                    if (!hasMatchingItem) return false;
                }
                
                // ê°€ê²© ë²”ìœ„ í•„í„°
                if (priceRangeFilter) {
                    const [min, max] = priceRangeFilter.split('-').map(Number);
                    if (order.totalPrice < min || order.totalPrice > max) return false;
                }
                
                return true;
            });

            // ì •ë ¬ ì ìš©
            applySorting(sortBy);
            
            renderOrders();
            updateStatistics();
        }

        // ì •ë ¬ ì ìš©
        function applySorting(sortBy) {
            filteredOrders.sort((a, b) => {
                let aValue = a[sortBy];
                let bValue = b[sortBy];
                
                if (sortBy === 'createdAt' || sortBy === 'updatedAt') {
                    aValue = new Date(aValue);
                    bValue = new Date(bValue);
                }
                
                if (sortOrder === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });
        }

        // ì •ë ¬ ìˆœì„œ í† ê¸€
        function toggleSortOrder() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            document.getElementById('sortOrderText').textContent = sortOrder === 'asc' ? 'â¬†ï¸' : 'â¬‡ï¸';
            applyFilters();
        }

        // í•„í„° ì´ˆê¸°í™”
        function resetFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('dateRangeFilter').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('orderIdSearch').value = '';
            document.getElementById('menuSearch').value = '';
            document.getElementById('priceRangeFilter').value = '';
            document.getElementById('sortBy').value = 'createdAt';
            sortOrder = 'desc';
            document.getElementById('sortOrderText').textContent = 'â¬‡ï¸';
            applyFilters();
        }

        // ì£¼ë¬¸ ìƒì„¸ ì •ë³´ í‘œì‹œ
        function showOrderDetail(order) {
            document.getElementById('orderDetailModal').style.display = 'block';
            
            const content = document.getElementById('orderDetailContent');
            content.innerHTML = `
                <div class="order-detail-header">
                    <h3>ì£¼ë¬¸ #${order.orderId}</h3>
                    <span class="badge ${Utils.getOrderStatusBadge(order.status)}">${Utils.getOrderStatusName(order.status)}</span>
                </div>
                
                <div class="order-info-grid">
                    <div class="order-info-section">
                        <h4>ì£¼ë¬¸ ì •ë³´</h4>
                        <div class="info-item">
                            <span class="info-label">ì£¼ë¬¸ì‹œê°„:</span>
                            <span class="info-value">${Utils.formatDate(order.createdAt)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ìµœê·¼ ì—…ë°ì´íŠ¸:</span>
                            <span class="info-value">${Utils.formatDate(order.updatedAt)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ì´ ê¸ˆì•¡:</span>
                            <span class="info-value"><strong>${Utils.formatPrice(order.totalPrice)}</strong></span>
                        </div>
                    </div>
                </div>
                
                <div class="order-items-section">
                    <h4>ì£¼ë¬¸ ë‚´ì—­</h4>
                    <div class="order-items-list">
                        ${order.items.map(item => `
                            <div class="order-item">
                                <div class="item-info">
                                    <strong>${item.name}</strong>
                                    <div class="item-details">
                                        <span>ìˆ˜ëŸ‰: ${item.quantity}ê°œ</span>
                                        <span>ë‹¨ê°€: ${Utils.formatPrice(item.price)}</span>
                                        <span>ì†Œê³„: ${Utils.formatPrice(item.price * item.quantity)}</span>
                                    </div>
                                    ${item.options && item.options.length > 0 ? 
                                        `<div class="item-options">ì˜µì…˜: ${item.options.join(', ')}</div>` : 
                                        ''
                                    }
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ëª¨ë‹¬
        function showStatusChangeModal(order) {
            const statusOptions = [
                { value: 'pending', label: 'ëŒ€ê¸°ì¤‘' },
                { value: 'preparing', label: 'ì¤€ë¹„ì¤‘' },
                { value: 'ready', label: 'ì¤€ë¹„ì™„ë£Œ' },
                { value: 'completed', label: 'ì™„ë£Œ' },
                { value: 'cancelled', label: 'ì·¨ì†Œë¨' }
            ];

            const optionsHtml = statusOptions.map(option => 
                `<option value="${option.value}" ${option.value === order.status ? 'selected' : ''}>${option.label}</option>`
            ).join('');

            const content = `
                <div class="status-change-form">
                    <p><strong>ì£¼ë¬¸ #${order.orderId}</strong>ì˜ ìƒíƒœë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.</p>
                    <div class="form-group">
                        <label class="form-label">ìƒˆë¡œìš´ ìƒíƒœ:</label>
                        <select class="form-select" id="newStatus">
                            ${optionsHtml}
                        </select>
                    </div>
                </div>
            `;

            Modal.show('ì£¼ë¬¸ ìƒíƒœ ë³€ê²½', content, [
                {
                    text: 'ì·¨ì†Œ',
                    class: 'btn-secondary',
                    onClick: () => Modal.hide()
                },
                {
                    text: 'ìƒíƒœ ë³€ê²½',
                    class: 'btn-primary',
                    onClick: () => updateOrderStatus(order.orderId, document.getElementById('newStatus').value)
                }
            ]);
        }

        // ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸
        async function updateOrderStatus(orderId, newStatus) {
            try {
                Loading.show();
                await API.patch(`/orders/${orderId}/status`, { status: newStatus });
                Notification.success('ì£¼ë¬¸ ìƒíƒœê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                Modal.hide();
                await loadOrders();
            } catch (error) {
                console.error('ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
                Notification.error('ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                Loading.hide();
            }
        }

        // ì£¼ë¬¸ ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
        function closeOrderDetailModal() {
            document.getElementById('orderDetailModal').style.display = 'none';
        }

        // ì£¼ë¬¸ ìƒˆë¡œê³ ì¹¨
        async function refreshOrders() {
            await loadOrders();
            Notification.success('ì£¼ë¬¸ ëª©ë¡ì´ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì£¼ë¬¸ ìƒì„¸ ìŠ¤íƒ€ì¼
        const orderDetailStyle = `
            .order-detail-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 2rem;
                padding-bottom: 1rem;
                border-bottom: 2px solid #f0f0f0;
            }
            
            .order-info-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 1rem;
                margin-bottom: 2rem;
            }
            
            .order-info-section h4 {
                margin-bottom: 1rem;
                color: #333;
            }
            
            .info-item {
                display: flex;
                justify-content: space-between;
                padding: 0.5rem 0;
                border-bottom: 1px solid #f0f0f0;
            }
            
            .info-label {
                font-weight: 500;
                color: #666;
            }
            
            .info-value {
                color: #333;
            }
            
            .order-items-section h4 {
                margin-bottom: 1rem;
                color: #333;
            }
            
            .order-item {
                padding: 1rem;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                margin-bottom: 1rem;
            }
            
            .item-info strong {
                font-size: 1.1rem;
                color: #333;
            }
            
            .item-details {
                display: flex;
                gap: 1rem;
                margin-top: 0.5rem;
                font-size: 0.9rem;
                color: #666;
            }
            
            .item-options {
                margin-top: 0.5rem;
                font-size: 0.9rem;
                color: #888;
                font-style: italic;
            }
            
            .status-change-form {
                padding: 1rem 0;
            }
            
            .grid-5 {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        `;

        const style = document.createElement('style');
        style.textContent = orderDetailStyle;
        document.head.appendChild(style);

        // ë‚ ì§œ ë²”ìœ„ ë³€ê²½ ì‹œ ì‚¬ìš©ì ì •ì˜ í•„ë“œ í™œì„±í™”
        document.getElementById('dateRangeFilter').addEventListener('change', function() {
            const isCustom = this.value === 'custom';
            document.getElementById('startDate').disabled = !isCustom;
            document.getElementById('endDate').disabled = !isCustom;
            
            if (!isCustom) {
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
            }
        });

        // ì´ˆê¸° ì„¤ì •
        document.getElementById('startDate').disabled = true;
        document.getElementById('endDate').disabled = true;
    </script>
</body>
</html> 