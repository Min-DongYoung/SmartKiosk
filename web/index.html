<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ í‚¤ì˜¤ìŠ¤í¬ ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <div class="header-container">
            <div class="logo">ğŸª ìŠ¤ë§ˆíŠ¸ í‚¤ì˜¤ìŠ¤í¬ ê´€ë¦¬ì</div>
            <nav class="nav-links">
                <a href="index.html" class="active">ëŒ€ì‹œë³´ë“œ</a>
                <a href="menus.html">ë©”ë‰´ ê´€ë¦¬</a>
                <a href="orders.html">ì£¼ë¬¸ ë‚´ì—­</a>
                <a href="statistics.html">ì£¼ë¬¸ í†µê³„</a>
                <a href="advertisements.html">ê´‘ê³  ê´€ë¦¬</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <h1>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
        
        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="grid grid-4">
            <div class="stat-card">
                <div class="stat-number" id="totalMenus">-</div>
                <div class="stat-label">ì „ì²´ ë©”ë‰´</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="availableMenus">-</div>
                <div class="stat-label">íŒë§¤ ì¤‘ì¸ ë©”ë‰´</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayOrders">-</div>
                <div class="stat-label">ì˜¤ëŠ˜ ì£¼ë¬¸ ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayRevenue">-</div>
                <div class="stat-label">ì˜¤ëŠ˜ ë§¤ì¶œ</div>
            </div>
        </div>

        <!-- ë¹ ë¥¸ ì•¡ì„¸ìŠ¤ ë©”ë‰´ -->
        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ë¹ ë¥¸ ë©”ë‰´</h2>
                </div>
                <div class="grid grid-2">
                    <a href="menus.html" class="btn btn-success">
                        ğŸ“ ë©”ë‰´ ê´€ë¦¬
                    </a>
                    <a href="orders.html" class="btn btn-info">
                        ğŸ“‹ ì£¼ë¬¸ ë‚´ì—­
                    </a>
                    <a href="advertisements.html" class="btn btn-warning">
                        ğŸ“¢ ê´‘ê³  ê´€ë¦¬
                    </a>
                    <button class="btn btn-secondary" onclick="refreshData()">
                        ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ì‹œìŠ¤í…œ ìƒíƒœ</h2>
                </div>
                <div class="system-status">
                    <div class="status-item">
                        <span class="status-label">ì„œë²„ ìƒíƒœ:</span>
                        <span class="badge badge-success">ì •ìƒ</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ë°ì´í„°ë² ì´ìŠ¤:</span>
                        <span class="badge badge-success">ì—°ê²°ë¨</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:</span>
                        <span id="lastUpdate">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìµœê·¼ ì£¼ë¬¸ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ìµœê·¼ ì£¼ë¬¸</h2>
                <a href="orders.html" class="btn btn-sm">ì „ì²´ ë³´ê¸°</a>
            </div>
            <div id="recentOrders" class="table-responsive">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- í’ˆì ˆ ë©”ë‰´ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">í’ˆì ˆ ë©”ë‰´</h2>
                <a href="menus.html" class="btn btn-sm">ê´€ë¦¬í•˜ê¸°</a>
            </div>
            <div id="soldOutMenus" class="table-responsive">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- í™œì„± ê´‘ê³  -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">í™œì„± ê´‘ê³ </h2>
                <a href="advertisements.html" class="btn btn-sm">ê´€ë¦¬í•˜ê¸°</a>
            </div>
            <div id="activeAds" class="table-responsive">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="script.js"></script>
    <script>
        // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
        async function loadDashboardData() {
            try {
                // í†µê³„ ë°ì´í„° ë¡œë“œ
                await loadStatistics();
                
                // ìµœê·¼ ì£¼ë¬¸ ë¡œë“œ
                await loadRecentOrders();
                
                // í’ˆì ˆ ë©”ë‰´ ë¡œë“œ
                await loadSoldOutMenus();
                
                // í™œì„± ê´‘ê³  ë¡œë“œ
                await loadActiveAds();
                
                // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ ì„¤ì •
                document.getElementById('lastUpdate').textContent = Utils.formatDate(new Date());
                
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                Notification.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í†µê³„ ë°ì´í„° ë¡œë“œ
        async function loadStatistics() {
            try {
                // ë©”ë‰´ í†µê³„
                const menusData = await API.get('/menus');
                const totalMenus = menusData.data.length;
                const availableMenus = menusData.data.filter(menu => menu.isAvailable).length;
                
                document.getElementById('totalMenus').textContent = totalMenus;
                document.getElementById('availableMenus').textContent = availableMenus;

                // ì˜¤ëŠ˜ ì£¼ë¬¸ í†µê³„
                const today = new Date().toISOString().split('T')[0];
                const ordersData = await API.get(`/orders?date=${today}`);
                const todayOrders = ordersData.data.length;
                
                // ì˜¤ëŠ˜ ë§¤ì¶œ ê³„ì‚°
                const todayRevenue = ordersData.data.reduce((sum, order) => {
                    return sum + (order.totalPrice || 0);
                }, 0);
                
                document.getElementById('todayOrders').textContent = todayOrders;
                document.getElementById('todayRevenue').textContent = Utils.formatPrice(todayRevenue);
                
            } catch (error) {
                console.error('í†µê³„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ìµœê·¼ ì£¼ë¬¸ ë¡œë“œ
        async function loadRecentOrders() {
            try {
                const ordersData = await API.get('/orders?limit=5');
                const container = document.getElementById('recentOrders');
                
                if (ordersData.data.length === 0) {
                    container.innerHTML = '<p class="text-center">ìµœê·¼ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                const columns = [
                    { 
                        key: 'orderId', 
                        header: 'ì£¼ë¬¸ë²ˆí˜¸',
                        render: (value) => `#${value}`
                    },
                    { 
                        key: 'items', 
                        header: 'ë©”ë‰´',
                        render: (items) => {
                            const firstItem = items[0];
                            const count = items.length;
                            return count > 1 ? `${firstItem.name} ì™¸ ${count-1}ê°œ` : firstItem.name;
                        }
                    },
                    { 
                        key: 'totalPrice', 
                        header: 'ì´ ê¸ˆì•¡',
                        render: (value) => Utils.formatPrice(value)
                    },
                    { 
                        key: 'status', 
                        header: 'ìƒíƒœ',
                        render: (value) => `<span class="badge ${Utils.getOrderStatusBadge(value)}">${Utils.getOrderStatusName(value)}</span>`
                    },
                    { 
                        key: 'createdAt', 
                        header: 'ì£¼ë¬¸ì‹œê°„',
                        render: (value) => Utils.formatDate(value)
                    }
                ];

                Table.render(container, ordersData.data, columns);
                
            } catch (error) {
                console.error('ìµœê·¼ ì£¼ë¬¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('recentOrders').innerHTML = '<p class="text-center">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }

        // í’ˆì ˆ ë©”ë‰´ ë¡œë“œ
        async function loadSoldOutMenus() {
            try {
                const menusData = await API.get('/menus?available=false');
                const container = document.getElementById('soldOutMenus');
                
                if (menusData.data.length === 0) {
                    container.innerHTML = '<p class="text-center">í’ˆì ˆëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                const columns = [
                    { 
                        key: 'image', 
                        header: 'ì´ë¯¸ì§€',
                        render: (value) => value ? `<img src="${value}" alt="ë©”ë‰´" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;">` : 'ì´ë¯¸ì§€ ì—†ìŒ'
                    },
                    { key: 'name', header: 'ë©”ë‰´ëª…' },
                    { 
                        key: 'category', 
                        header: 'ì¹´í…Œê³ ë¦¬',
                        render: (value) => Utils.getCategoryName(value)
                    },
                    { 
                        key: 'price', 
                        header: 'ê°€ê²©',
                        render: (value) => Utils.formatPrice(value)
                    }
                ];

                const actions = [
                    {
                        text: 'íŒë§¤ ì¬ê°œ',
                        class: 'btn-success',
                        onClick: (menu) => toggleMenuAvailability(menu.id, true)
                    }
                ];

                Table.render(container, menusData.data, columns, actions);
                
            } catch (error) {
                console.error('í’ˆì ˆ ë©”ë‰´ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('soldOutMenus').innerHTML = '<p class="text-center">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }

        // í™œì„± ê´‘ê³  ë¡œë“œ
        async function loadActiveAds() {
            try {
                const adsData = await API.get('/advertisements?active=true');
                const container = document.getElementById('activeAds');
                
                if (adsData.data.length === 0) {
                    container.innerHTML = '<p class="text-center">í™œì„± ê´‘ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                const columns = [
                    { 
                        key: 'image', 
                        header: 'ì´ë¯¸ì§€',
                        render: (value) => value ? `<img src="${value}" alt="ê´‘ê³ " style="width: 80px; height: 50px; object-fit: cover; border-radius: 5px;">` : 'ì´ë¯¸ì§€ ì—†ìŒ'
                    },
                    { key: 'title', header: 'ì œëª©' },
                    { key: 'description', header: 'ì„¤ëª…' },
                    { 
                        key: 'position', 
                        header: 'ìœ„ì¹˜',
                        render: (value) => value === 'main' ? 'ë©”ì¸ í™”ë©´' : 'ìƒì„¸ í™”ë©´'
                    },
                    { key: 'priority', header: 'ìš°ì„ ìˆœìœ„' }
                ];

                const actions = [
                    {
                        text: 'ë¹„í™œì„±í™”',
                        class: 'btn-warning',
                        onClick: (ad) => toggleAdStatus(ad._id, false)
                    }
                ];

                Table.render(container, adsData.data, columns, actions);
                
            } catch (error) {
                console.error('í™œì„± ê´‘ê³  ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('activeAds').innerHTML = '<p class="text-center">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }

        // ë©”ë‰´ íŒë§¤ ìƒíƒœ í† ê¸€
        async function toggleMenuAvailability(menuId, isAvailable) {
            try {
                Loading.show();
                await API.put(`/menus/${menuId}`, { isAvailable });
                Notification.success(`ë©”ë‰´ê°€ ${isAvailable ? 'íŒë§¤ ì¬ê°œ' : 'í’ˆì ˆ ì²˜ë¦¬'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                await loadSoldOutMenus();
                await loadStatistics();
            } catch (error) {
                console.error('ë©”ë‰´ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
                Notification.error('ë©”ë‰´ ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                Loading.hide();
            }
        }

        // ê´‘ê³  ìƒíƒœ í† ê¸€
        async function toggleAdStatus(adId, isActive) {
            try {
                Loading.show();
                await API.put(`/advertisements/${adId}`, { isActive });
                Notification.success(`ê´‘ê³ ê°€ ${isActive ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                await loadActiveAds();
            } catch (error) {
                console.error('ê´‘ê³  ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
                Notification.error('ê´‘ê³  ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                Loading.hide();
            }
        }

        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        async function refreshData() {
            Loading.show();
            await loadDashboardData();
            Loading.hide();
            Notification.success('ë°ì´í„°ê°€ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì‹œìŠ¤í…œ ìƒíƒœ ìŠ¤íƒ€ì¼
        const systemStatusStyle = `
            .system-status {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }
            .status-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem;
                background: #f8f9fa;
                border-radius: 5px;
            }
            .status-label {
                font-weight: 500;
            }
        `;

        // ìŠ¤íƒ€ì¼ ì¶”ê°€
        const style = document.createElement('style');
        style.textContent = systemStatusStyle;
        document.head.appendChild(style);

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
        document.addEventListener('DOMContentLoaded', loadDashboardData);
    </script>
</body>
</html> 