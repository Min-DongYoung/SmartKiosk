<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´‘ê³  ê´€ë¦¬ - ìŠ¤ë§ˆíŠ¸ í‚¤ì˜¤ìŠ¤í¬ ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <div class="header-container">
            <div class="logo">ğŸª ìŠ¤ë§ˆíŠ¸ í‚¤ì˜¤ìŠ¤í¬ ê´€ë¦¬ì</div>
            <nav class="nav-links">
                <a href="index.html">ëŒ€ì‹œë³´ë“œ</a>
                <a href="menus.html">ë©”ë‰´ ê´€ë¦¬</a>
                <a href="orders.html">ì£¼ë¬¸ ë‚´ì—­</a>
                <a href="statistics.html">ì£¼ë¬¸ í†µê³„</a>
                <a href="advertisements.html" class="active">ê´‘ê³  ê´€ë¦¬</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="card-header">
            <h1 class="card-title">ê´‘ê³  ê´€ë¦¬</h1>
            <button class="btn btn-success" onclick="showAddAdModal()">
                â• ìƒˆ ê´‘ê³  ì¶”ê°€
            </button>
        </div>

        <!-- í•„í„° ë° ê²€ìƒ‰ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">í•„í„° ë° ê²€ìƒ‰</h2>
                <button class="btn btn-sm btn-secondary" onclick="resetFilters()">
                    ğŸ”„ í•„í„° ì´ˆê¸°í™”
                </button>
            </div>
            <div class="grid grid-4">
                <div class="form-group">
                    <label class="form-label">ê´‘ê³  ìœ„ì¹˜</label>
                    <select class="form-select" id="positionFilter" onchange="applyFilters()">
                        <option value="">ì „ì²´ ìœ„ì¹˜</option>
                        <option value="main">ë©”ì¸ í™”ë©´</option>
                        <option value="detail">ìƒì„¸ í™”ë©´</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">í™œì„± ìƒíƒœ</label>
                    <select class="form-select" id="activeFilter" onchange="applyFilters()">
                        <option value="">ì „ì²´ ìƒíƒœ</option>
                        <option value="true">í™œì„±</option>
                        <option value="false">ë¹„í™œì„±</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ì œëª© ê²€ìƒ‰</label>
                    <input type="text" class="form-control" id="titleSearch" placeholder="ê´‘ê³  ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" onkeyup="applyFilters()">
                </div>
                <div class="form-group">
                    <label class="form-label">ìš°ì„ ìˆœìœ„</label>
                    <select class="form-select" id="priorityFilter" onchange="applyFilters()">
                        <option value="">ì „ì²´ ìš°ì„ ìˆœìœ„</option>
                        <option value="high">ë†’ìŒ (8-10)</option>
                        <option value="medium">ë³´í†µ (4-7)</option>
                        <option value="low">ë‚®ìŒ (1-3)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ê´‘ê³  í†µê³„ -->
        <div class="grid grid-4">
            <div class="stat-card">
                <div class="stat-number" id="totalAdsCount">-</div>
                <div class="stat-label">ì „ì²´ ê´‘ê³ </div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeAdsCount">-</div>
                <div class="stat-label">í™œì„± ê´‘ê³ </div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="mainAdsCount">-</div>
                <div class="stat-label">ë©”ì¸ í™”ë©´</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="detailAdsCount">-</div>
                <div class="stat-label">ìƒì„¸ í™”ë©´</div>
            </div>
        </div>

        <!-- ê´‘ê³  ëª©ë¡ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ê´‘ê³  ëª©ë¡</h2>
                <div class="d-flex gap-2">
                    <select class="form-select" id="sortBy" onchange="applyFilters()" style="width: 200px;">
                        <option value="priority">ìš°ì„ ìˆœìœ„ìˆœ</option>
                        <option value="title">ì œëª©ìˆœ</option>
                        <option value="position">ìœ„ì¹˜ìˆœ</option>
                        <option value="createdAt">ìƒì„±ì¼ìˆœ</option>
                        <option value="updatedAt">ìˆ˜ì •ì¼ìˆœ</option>
                    </select>
                    <button class="btn btn-sm btn-secondary" onclick="toggleSortOrder()">
                        <span id="sortOrderText">â¬‡ï¸</span>
                    </button>
                </div>
            </div>
            <div id="adsList" class="table-responsive">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ê´‘ê³  ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="adModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="modal-close" onclick="closeAdModal()">&times;</span>
            <h2 id="modalTitle">ìƒˆ ê´‘ê³  ì¶”ê°€</h2>
            
            <form id="adForm" onsubmit="submitAd(event)">
                <div class="form-group">
                    <label class="form-label">ê´‘ê³  ì œëª© *</label>
                    <input type="text" class="form-control" id="adTitle" required>
                </div>

                <div class="form-group">
                    <label class="form-label">ê´‘ê³  ì„¤ëª…</label>
                    <textarea class="form-control" id="adDescription" rows="3" placeholder="ê´‘ê³  ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">ê´‘ê³  ìœ„ì¹˜ *</label>
                        <select class="form-select" id="adPosition" required>
                            <option value="">ìœ„ì¹˜ ì„ íƒ</option>
                            <option value="main">ë©”ì¸ í™”ë©´</option>
                            <option value="detail">ìƒì„¸ í™”ë©´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ìš°ì„ ìˆœìœ„ *</label>
                        <input type="number" class="form-control" id="adPriority" required min="1" max="10" value="5">
                        <small>1(ë‚®ìŒ) ~ 10(ë†’ìŒ)</small>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ì´ë¯¸ì§€ URL *</label>
                    <input type="url" class="form-control" id="adImage" required placeholder="ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”">
                    <small>ì˜ˆ: /img/ad_img_3.jpg</small>
                </div>

                <div class="form-group">
                    <label class="form-label">ë§í¬ URL</label>
                    <input type="url" class="form-control" id="adLink" placeholder="í´ë¦­ ì‹œ ì´ë™í•  URL (ì„ íƒì‚¬í•­)">
                </div>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">ì‹œì‘ì¼</label>
                        <input type="date" class="form-control" id="adStartDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì¢…ë£Œì¼</label>
                        <input type="date" class="form-control" id="adEndDate">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">í™œì„± ìƒíƒœ</label>
                    <select class="form-select" id="adActive">
                        <option value="true">í™œì„±</option>
                        <option value="false">ë¹„í™œì„±</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</label>
                    <div id="imagePreview" style="width: 100%; height: 200px; border: 2px dashed #ddd; display: flex; align-items: center; justify-content: center; color: #999; border-radius: 8px;">
                        ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-3">
                    <button type="button" class="btn btn-secondary" onclick="closeAdModal()">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit" class="btn btn-success">
                        ì €ì¥
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module" src="script.js"></script>
    <script>
        let allAds = [];
        let filteredAds = [];
        let sortOrder = 'desc';
        let currentEditingAd = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê´‘ê³  ëª©ë¡ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', loadAds);

        // ê´‘ê³  ëª©ë¡ ë¡œë“œ
        async function loadAds() {
            try {
                Loading.show('#adsList');
                const response = await API.get('/advertisements');
                allAds = response.data;
                filteredAds = [...allAds];
                
                renderAds();
                updateStatistics();
                
            } catch (error) {
                console.error('ê´‘ê³  ë¡œë“œ ì‹¤íŒ¨:', error);
                Notification.error('ê´‘ê³  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                Loading.hide('#adsList');
            }
        }

        // ê´‘ê³  ë Œë”ë§
        function renderAds() {
            const container = document.getElementById('adsList');
            
            if (filteredAds.length === 0) {
                container.innerHTML = '<p class="text-center">ì¡°ê±´ì— ë§ëŠ” ê´‘ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const columns = [
                { 
                    key: 'image', 
                    header: 'ì´ë¯¸ì§€',
                    render: (value) => value ? 
                        `<img src="${value}" alt="ê´‘ê³ " style="width: 100px; height: 60px; object-fit: cover; border-radius: 5px;">` : 
                        '<div style="width: 100px; height: 60px; background: #f0f0f0; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 12px;">ì´ë¯¸ì§€<br>ì—†ìŒ</div>'
                },
                { 
                    key: 'title', 
                    header: 'ì œëª©',
                    render: (value) => `<strong>${value}</strong>`
                },
                { 
                    key: 'description', 
                    header: 'ì„¤ëª…',
                    render: (value) => value ? (value.length > 50 ? value.substring(0, 50) + '...' : value) : '-'
                },
                { 
                    key: 'position', 
                    header: 'ìœ„ì¹˜',
                    render: (value) => value === 'main' ? 'ë©”ì¸ í™”ë©´' : 'ìƒì„¸ í™”ë©´'
                },
                { 
                    key: 'priority', 
                    header: 'ìš°ì„ ìˆœìœ„',
                    render: (value) => `<span class="badge ${value >= 8 ? 'badge-danger' : value >= 4 ? 'badge-warning' : 'badge-info'}">${value}</span>`
                },
                { 
                    key: 'isActive', 
                    header: 'ìƒíƒœ',
                    render: (value) => value ? 
                        '<span class="badge badge-success">í™œì„±</span>' : 
                        '<span class="badge badge-secondary">ë¹„í™œì„±</span>'
                },
                { 
                    key: 'updatedAt', 
                    header: 'ìµœê·¼ ìˆ˜ì •',
                    render: (value) => Utils.formatDate(value)
                }
            ];

            const actions = [
                {
                    text: 'ìˆ˜ì •',
                    class: 'btn-primary',
                    onClick: (ad) => editAd(ad)
                },
                {
                    text: ad => ad.isActive ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”',
                    class: ad => ad.isActive ? 'btn-warning' : 'btn-success',
                    onClick: (ad) => toggleAdStatus(ad)
                },
                {
                    text: 'ì‚­ì œ',
                    class: 'btn-danger',
                    onClick: (ad) => deleteAd(ad)
                }
            ];

            Table.render(container, filteredAds, columns, actions);
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics() {
            const total = allAds.length;
            const active = allAds.filter(ad => ad.isActive).length;
            const main = allAds.filter(ad => ad.position === 'main').length;
            const detail = allAds.filter(ad => ad.position === 'detail').length;

            document.getElementById('totalAdsCount').textContent = total;
            document.getElementById('activeAdsCount').textContent = active;
            document.getElementById('mainAdsCount').textContent = main;
            document.getElementById('detailAdsCount').textContent = detail;
        }

        // í•„í„° ì ìš©
        function applyFilters() {
            const positionFilter = document.getElementById('positionFilter').value;
            const activeFilter = document.getElementById('activeFilter').value;
            const titleSearch = document.getElementById('titleSearch').value.toLowerCase();
            const priorityFilter = document.getElementById('priorityFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            filteredAds = allAds.filter(ad => {
                // ìœ„ì¹˜ í•„í„°
                if (positionFilter && ad.position !== positionFilter) return false;
                
                // í™œì„± ìƒíƒœ í•„í„°
                if (activeFilter && ad.isActive.toString() !== activeFilter) return false;
                
                // ì œëª© ê²€ìƒ‰
                if (titleSearch && !ad.title.toLowerCase().includes(titleSearch)) return false;
                
                // ìš°ì„ ìˆœìœ„ í•„í„°
                if (priorityFilter) {
                    if (priorityFilter === 'high' && ad.priority < 8) return false;
                    if (priorityFilter === 'medium' && (ad.priority < 4 || ad.priority > 7)) return false;
                    if (priorityFilter === 'low' && ad.priority > 3) return false;
                }
                
                return true;
            });

            // ì •ë ¬ ì ìš©
            applySorting(sortBy);
            
            renderAds();
        }

        // ì •ë ¬ ì ìš©
        function applySorting(sortBy) {
            filteredAds.sort((a, b) => {
                let aValue = a[sortBy];
                let bValue = b[sortBy];
                
                if (sortBy === 'createdAt' || sortBy === 'updatedAt') {
                    aValue = new Date(aValue);
                    bValue = new Date(bValue);
                }
                
                if (sortOrder === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });
        }

        // ì •ë ¬ ìˆœì„œ í† ê¸€
        function toggleSortOrder() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            document.getElementById('sortOrderText').textContent = sortOrder === 'asc' ? 'â¬†ï¸' : 'â¬‡ï¸';
            applyFilters();
        }

        // í•„í„° ì´ˆê¸°í™”
        function resetFilters() {
            document.getElementById('positionFilter').value = '';
            document.getElementById('activeFilter').value = '';
            document.getElementById('titleSearch').value = '';
            document.getElementById('priorityFilter').value = '';
            document.getElementById('sortBy').value = 'priority';
            sortOrder = 'desc';
            document.getElementById('sortOrderText').textContent = 'â¬‡ï¸';
            applyFilters();
        }

        // ê´‘ê³  ì¶”ê°€ ëª¨ë‹¬ í‘œì‹œ
        function showAddAdModal() {
            currentEditingAd = null;
            document.getElementById('modalTitle').textContent = 'ìƒˆ ê´‘ê³  ì¶”ê°€';
            document.getElementById('adForm').reset();
            document.getElementById('adPriority').value = 5;
            document.getElementById('adActive').value = 'true';
            updateImagePreview('');
            document.getElementById('adModal').style.display = 'block';
        }

        // ê´‘ê³  ìˆ˜ì •
        function editAd(ad) {
            currentEditingAd = ad;
            document.getElementById('modalTitle').textContent = 'ê´‘ê³  ìˆ˜ì •';
            
            // í¼ í•„ë“œ ì±„ìš°ê¸°
            document.getElementById('adTitle').value = ad.title;
            document.getElementById('adDescription').value = ad.description || '';
            document.getElementById('adPosition').value = ad.position;
            document.getElementById('adPriority').value = ad.priority;
            document.getElementById('adImage').value = ad.image;
            document.getElementById('adLink').value = ad.link || '';
            document.getElementById('adStartDate').value = ad.startDate ? ad.startDate.split('T')[0] : '';
            document.getElementById('adEndDate').value = ad.endDate ? ad.endDate.split('T')[0] : '';
            document.getElementById('adActive').value = ad.isActive.toString();
            
            updateImagePreview(ad.image);
            document.getElementById('adModal').style.display = 'block';
        }

        // ê´‘ê³  ëª¨ë‹¬ ë‹«ê¸°
        function closeAdModal() {
            document.getElementById('adModal').style.display = 'none';
            currentEditingAd = null;
        }

        // ê´‘ê³  ì €ì¥
        async function submitAd(event) {
            event.preventDefault();
            
            try {
                Loading.show();
                
                const formData = {
                    title: document.getElementById('adTitle').value,
                    description: document.getElementById('adDescription').value,
                    position: document.getElementById('adPosition').value,
                    priority: parseInt(document.getElementById('adPriority').value),
                    image: document.getElementById('adImage').value,
                    link: document.getElementById('adLink').value,
                    startDate: document.getElementById('adStartDate').value || null,
                    endDate: document.getElementById('adEndDate').value || null,
                    isActive: document.getElementById('adActive').value === 'true'
                };
                
                if (currentEditingAd) {
                    // ìˆ˜ì •
                    await API.put(`/advertisements/${currentEditingAd._id}`, formData);
                    Notification.success('ê´‘ê³ ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    // ì¶”ê°€
                    await API.post('/advertisements', formData);
                    Notification.success('ê´‘ê³ ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
                
                closeAdModal();
                await loadAds();
                
            } catch (error) {
                console.error('ê´‘ê³  ì €ì¥ ì‹¤íŒ¨:', error);
                Notification.error('ê´‘ê³  ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                Loading.hide();
            }
        }

        // ê´‘ê³  ìƒíƒœ í† ê¸€
        async function toggleAdStatus(ad) {
            const newStatus = !ad.isActive;
            const action = newStatus ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”';
            
            Modal.confirm(
                'ê´‘ê³  ìƒíƒœ ë³€ê²½',
                `'${ad.title}' ê´‘ê³ ë¥¼ ${action}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                async () => {
                    try {
                        Loading.show();
                        await API.put(`/advertisements/${ad._id}`, { isActive: newStatus });
                        Notification.success(`ê´‘ê³ ê°€ ${action}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        await loadAds();
                    } catch (error) {
                        console.error('ê´‘ê³  ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
                        Notification.error('ê´‘ê³  ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    } finally {
                        Loading.hide();
                    }
                }
            );
        }

        // ê´‘ê³  ì‚­ì œ
        async function deleteAd(ad) {
            Modal.confirm(
                'ê´‘ê³  ì‚­ì œ',
                `'${ad.title}' ê´‘ê³ ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><strong>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</strong>`,
                async () => {
                    try {
                        Loading.show();
                        await API.delete(`/advertisements/${ad._id}`);
                        Notification.success('ê´‘ê³ ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        await loadAds();
                    } catch (error) {
                        console.error('ê´‘ê³  ì‚­ì œ ì‹¤íŒ¨:', error);
                        Notification.error('ê´‘ê³  ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    } finally {
                        Loading.hide();
                    }
                }
            );
        }

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updateImagePreview(imageUrl) {
            const preview = document.getElementById('imagePreview');
            
            if (imageUrl) {
                preview.innerHTML = `<img src="${imageUrl}" alt="ë¯¸ë¦¬ë³´ê¸°" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 5px;">`;
            } else {
                preview.innerHTML = 'ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤';
            }
        }

        // ì´ë¯¸ì§€ URL ì…ë ¥ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        document.getElementById('adImage').addEventListener('input', function() {
            updateImagePreview(this.value);
        });

        // ì´ë¯¸ì§€ ë¡œë“œ ì˜¤ë¥˜ ì²˜ë¦¬
        document.getElementById('imagePreview').addEventListener('error', function(e) {
            if (e.target.tagName === 'IMG') {
                e.target.parentElement.innerHTML = 'ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
            }
        }, true);
    </script>
</body>
</html> 