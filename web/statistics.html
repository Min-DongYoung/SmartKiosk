<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ë¬¸ í†µê³„ - ìŠ¤ë§ˆíŠ¸ í‚¤ì˜¤ìŠ¤í¬ ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-container">
            <div class="logo">ğŸª ìŠ¤ë§ˆíŠ¸ í‚¤ì˜¤ìŠ¤í¬ ê´€ë¦¬ì</div>
            <nav class="nav-links">
                <a href="index.html">ëŒ€ì‹œë³´ë“œ</a>
                <a href="menus.html">ë©”ë‰´ ê´€ë¦¬</a>
                <a href="orders.html">ì£¼ë¬¸ ë‚´ì—­</a>
                <a href="statistics.html" class="active">ì£¼ë¬¸ í†µê³„</a>
                <a href="advertisements.html">ê´‘ê³  ê´€ë¦¬</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="card-header">
            <h1 class="card-title">ì£¼ë¬¸ í†µê³„</h1>
            <button class="btn btn-secondary" onclick="refreshStatistics()">
                ğŸ”„ ìƒˆë¡œê³ ì¹¨
            </button>
        </div>

        <!-- ê¸°ê°„ ì„ íƒ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ê¸°ê°„ ì„ íƒ</h2>
            </div>
            <div class="grid grid-4">
                <div class="form-group">
                    <label class="form-label">ê¸°ê°„ ì¢…ë¥˜</label>
                    <select class="form-select" id="periodType" onchange="updateDateInputs()">
                        <option value="today">ì˜¤ëŠ˜</option>
                        <option value="week">ì´ë²ˆ ì£¼</option>
                        <option value="month">ì´ë²ˆ ë‹¬</option>
                        <option value="custom">ì‚¬ìš©ì ì •ì˜</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ì‹œì‘ ë‚ ì§œ</label>
                    <input type="date" class="form-control" id="startDate" onchange="loadStatistics()">
                </div>
                <div class="form-group">
                    <label class="form-label">ì¢…ë£Œ ë‚ ì§œ</label>
                    <input type="date" class="form-control" id="endDate" onchange="loadStatistics()">
                </div>
                <div class="form-group">
                    <label class="form-label">ì°¨íŠ¸ ì¢…ë¥˜</label>
                    <select class="form-select" id="chartType" onchange="updateCharts()">
                        <option value="bar">ë§‰ëŒ€í˜•</option>
                        <option value="line">ì„ í˜•</option>
                        <option value="pie">ì›í˜•</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ì£¼ìš” í†µê³„ ì¹´ë“œ -->
        <div class="grid grid-4">
            <div class="stat-card">
                <div class="stat-number" id="totalOrdersCount">-</div>
                <div class="stat-label">ì´ ì£¼ë¬¸ ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalRevenue">-</div>
                <div class="stat-label">ì´ ë§¤ì¶œ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="averageOrderValue">-</div>
                <div class="stat-label">í‰ê·  ì£¼ë¬¸ì•¡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completionRate">-</div>
                <div class="stat-label">ì™„ë£Œìœ¨</div>
            </div>
        </div>

        <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
        <div class="grid grid-2">
            <!-- ì¼ë³„ ì£¼ë¬¸ ìˆ˜ -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ì¼ë³„ ì£¼ë¬¸ ìˆ˜</h3>
                </div>
                <div class="chart-container">
                    <canvas id="dailyOrdersChart"></canvas>
                </div>
            </div>

            <!-- ìƒíƒœë³„ ì£¼ë¬¸ ë¶„í¬ -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ìƒíƒœë³„ ì£¼ë¬¸ ë¶„í¬</h3>
                </div>
                <div class="chart-container">
                    <canvas id="statusDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-2">
            <!-- ì‹œê°„ëŒ€ë³„ ì£¼ë¬¸ íŒ¨í„´ -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ì‹œê°„ëŒ€ë³„ ì£¼ë¬¸ íŒ¨í„´</h3>
                </div>
                <div class="chart-container">
                    <canvas id="hourlyOrdersChart"></canvas>
                </div>
            </div>

            <!-- ì¸ê¸° ë©”ë‰´ ìˆœìœ„ -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ì¸ê¸° ë©”ë‰´ TOP 10</h3>
                </div>
                <div class="chart-container">
                    <canvas id="popularMenusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ë§¤ì¶œ ë¶„ì„ -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">ë§¤ì¶œ ë¶„ì„</h3>
            </div>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- ìƒì„¸ í†µê³„ í…Œì´ë¸” -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">ìƒì„¸ í†µê³„</h3>
            </div>
            <div id="detailStats" class="table-responsive">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="script.js"></script>
    <script>
        let statisticsData = {};
        let charts = {};

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í†µê³„ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', () => {
            initializeDateInputs();
            loadStatistics();
        });

        // ë‚ ì§œ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        function initializeDateInputs() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            document.getElementById('startDate').value = todayStr;
            document.getElementById('endDate').value = todayStr;
            document.getElementById('startDate').disabled = true;
            document.getElementById('endDate').disabled = true;
        }

        // ê¸°ê°„ ì¢…ë¥˜ ë³€ê²½ ì‹œ ë‚ ì§œ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
        function updateDateInputs() {
            const periodType = document.getElementById('periodType').value;
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const today = new Date();
            
            if (periodType === 'custom') {
                startDateInput.disabled = false;
                endDateInput.disabled = false;
            } else {
                startDateInput.disabled = true;
                endDateInput.disabled = true;
                
                let startDate = new Date(today);
                let endDate = new Date(today);
                
                switch (periodType) {
                    case 'today':
                        // ì˜¤ëŠ˜
                        break;
                    case 'week':
                        // ì´ë²ˆ ì£¼ (ì›”ìš”ì¼ë¶€í„°)
                        const dayOfWeek = today.getDay();
                        const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                        startDate = new Date(today.setDate(diff));
                        endDate = new Date(today);
                        break;
                    case 'month':
                        // ì´ë²ˆ ë‹¬
                        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                        endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                        break;
                }
                
                startDateInput.value = startDate.toISOString().split('T')[0];
                endDateInput.value = endDate.toISOString().split('T')[0];
            }
            
            loadStatistics();
        }

        // í†µê³„ ë°ì´í„° ë¡œë“œ
        async function loadStatistics() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) return;
                
                Loading.show();
                
                // ê¸°ë³¸ í†µê³„ ë¡œë“œ
                const basicStats = await API.get(`/orders/stats/range?startDate=${startDate}&endDate=${endDate}`);
                
                // ì‹œê°„ëŒ€ë³„ í†µê³„ ë¡œë“œ
                const hourlyStats = await API.get(`/orders/stats/hourly?startDate=${startDate}&endDate=${endDate}`);
                
                // ë©”ë‰´ë³„ í†µê³„ ë¡œë“œ
                const menuStats = await API.get(`/orders/stats/menu?startDate=${startDate}&endDate=${endDate}`);
                
                // ì¼ë³„ í†µê³„ ë¡œë“œ
                const dailyStats = await API.get(`/orders/stats/daily?startDate=${startDate}&endDate=${endDate}`);
                
                statisticsData = {
                    basic: basicStats.data || { totalOrders: 0, totalRevenue: 0, averageOrderValue: 0, completionRate: 0, statusBreakdown: [] },
                    hourly: hourlyStats.data || [],
                    menu: menuStats.data || [],
                    daily: dailyStats.data || []
                };
                
                updateStatisticsCards();
                updateCharts();
                updateDetailTable();
                
            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
                console.error('Error details:', error);
                Notification.error('í†µê³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                
                // ê¸°ë³¸ê°’ ì„¤ì •
                statisticsData = {
                    basic: { totalOrders: 0, totalRevenue: 0, averageOrderValue: 0, completionRate: 0, statusBreakdown: [] },
                    hourly: [],
                    menu: [],
                    daily: []
                };
                
                updateStatisticsCards();
                updateCharts();
                updateDetailTable();
            } finally {
                Loading.hide();
            }
        }

        // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
        function updateStatisticsCards() {
            const { basic } = statisticsData;
            
            document.getElementById('totalOrdersCount').textContent = basic.totalOrders || 0;
            document.getElementById('totalRevenue').textContent = Utils.formatPrice(basic.totalRevenue || 0);
            document.getElementById('averageOrderValue').textContent = Utils.formatPrice(basic.averageOrderValue || 0);
            document.getElementById('completionRate').textContent = `${basic.completionRate || 0}%`;
        }

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateCharts() {
            const chartType = document.getElementById('chartType').value;
            
            // ê¸°ì¡´ ì°¨íŠ¸ ì‚­ì œ
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            
            updateDailyOrdersChart(chartType);
            updateStatusDistributionChart();
            updateHourlyOrdersChart(chartType);
            updatePopularMenusChart(chartType);
            updateRevenueChart(chartType);
        }

        // ì¼ë³„ ì£¼ë¬¸ ìˆ˜ ì°¨íŠ¸
        function updateDailyOrdersChart(type) {
            const ctx = document.getElementById('dailyOrdersChart').getContext('2d');
            const { daily } = statisticsData;
            
            if (!daily || daily.length === 0) return;
            
            const labels = daily.map(d => d.date);
            const data = daily.map(d => d.orderCount);
            
            charts.dailyOrders = new Chart(ctx, {
                type: type === 'pie' ? 'bar' : type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì£¼ë¬¸ ìˆ˜',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // ìƒíƒœë³„ ì£¼ë¬¸ ë¶„í¬ ì°¨íŠ¸
        function updateStatusDistributionChart() {
            const ctx = document.getElementById('statusDistributionChart').getContext('2d');
            const { basic } = statisticsData;
            
            if (!basic || !basic.statusBreakdown) return;
            
            const labels = basic.statusBreakdown.map(s => Utils.getOrderStatusName(s._id));
            const data = basic.statusBreakdown.map(s => s.count);
            const colors = [
                '#ffd43b', '#51cf66', '#40c057', '#667eea', '#ff6b6b'
            ];
            
            charts.statusDistribution = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // ì‹œê°„ëŒ€ë³„ ì£¼ë¬¸ íŒ¨í„´ ì°¨íŠ¸
        function updateHourlyOrdersChart(type) {
            const ctx = document.getElementById('hourlyOrdersChart').getContext('2d');
            const { hourly } = statisticsData;
            
            if (!hourly || hourly.length === 0) return;
            
            const labels = hourly.map(h => `${h.hour}ì‹œ`);
            const data = hourly.map(h => h.orderCount);
            
            charts.hourlyOrders = new Chart(ctx, {
                type: type === 'pie' ? 'bar' : type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì£¼ë¬¸ ìˆ˜',
                        data: data,
                        backgroundColor: 'rgba(64, 192, 87, 0.8)',
                        borderColor: 'rgba(64, 192, 87, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // ì¸ê¸° ë©”ë‰´ ìˆœìœ„ ì°¨íŠ¸
        function updatePopularMenusChart(type) {
            const ctx = document.getElementById('popularMenusChart').getContext('2d');
            const { menu } = statisticsData;
            
            if (!menu || menu.length === 0) return;
            
            const top10 = menu.slice(0, 10);
            const labels = top10.map(m => m.name);
            const data = top10.map(m => m.totalQuantity);
            
            charts.popularMenus = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì£¼ë¬¸ ìˆ˜ëŸ‰',
                        data: data,
                        backgroundColor: type === 'pie' ? [
                            '#ff6b6b', '#51cf66', '#40c057', '#667eea', '#ffd43b',
                            '#fab005', '#fd7e14', '#e64980', '#ae3ec9', '#7c2d12'
                        ] : 'rgba(255, 107, 107, 0.8)',
                        borderColor: 'rgba(255, 107, 107, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: type === 'pie' ? {} : {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: type === 'pie',
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // ë§¤ì¶œ ë¶„ì„ ì°¨íŠ¸
        function updateRevenueChart(type) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            const { daily } = statisticsData;
            
            if (!daily || daily.length === 0) return;
            
            const labels = daily.map(d => d.date);
            const data = daily.map(d => d.revenue);
            
            charts.revenue = new Chart(ctx, {
                type: type === 'pie' ? 'line' : type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ë§¤ì¶œ (ì›)',
                        data: data,
                        backgroundColor: 'rgba(118, 75, 162, 0.8)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        borderWidth: 1,
                        fill: type === 'line' ? false : true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return Utils.formatPrice(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // ìƒì„¸ í†µê³„ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateDetailTable() {
            const container = document.getElementById('detailStats');
            const { menu } = statisticsData;
            
            if (!menu || menu.length === 0) {
                container.innerHTML = '<p class="text-center">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            const columns = [
                { key: 'name', header: 'ë©”ë‰´ëª…' },
                { key: 'totalQuantity', header: 'ì´ ì£¼ë¬¸ ìˆ˜ëŸ‰' },
                { key: 'totalRevenue', header: 'ì´ ë§¤ì¶œ', render: (value) => Utils.formatPrice(value) },
                { key: 'averagePrice', header: 'í‰ê·  ë‹¨ê°€', render: (value) => Utils.formatPrice(value) },
                { key: 'orderCount', header: 'ì£¼ë¬¸ íšŸìˆ˜' }
            ];
            
            Table.render(container, menu, columns);
        }

        // í†µê³„ ìƒˆë¡œê³ ì¹¨
        async function refreshStatistics() {
            await loadStatistics();
            Notification.success('í†µê³„ê°€ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼
        const chartStyle = `
            .chart-container {
                position: relative;
                height: 300px;
                margin: 1rem 0;
            }
            
            .grid-2 .chart-container {
                height: 250px;
            }
            
            .card .chart-container {
                height: 400px;
            }
        `;

        const style = document.createElement('style');
        style.textContent = chartStyle;
        document.head.appendChild(style);
    </script>
</body>
</html>